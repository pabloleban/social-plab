<html>
    <head>
        <meta charset="UTF-8">
        <script>
            window.$ = window.jQuery = require('jquery');
            require('jquery-ui-dist/jquery-ui')
            var {ipcRenderer, remote} = require('electron');
            require("bootstrap");
            const Swal = require('sweetalert2')
        </script>
        <link href="./node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
        <title>Social Plab</title>
        <style>
            @font-face {
                font-family: "Lato";
                src: url("assets/fonts/Lato-black.ttf");
            }

            svg {
                height: 30px !important;
            }

            .clickable{
                cursor: pointer;
            }

            .titlebar{
                background: rgba(0, 0, 0, 0.3);
            }

            body{
                background: var(--dark);
                color: white;
                overflow: hidden;
            }

            .main{
                position: relative;
                width: 1080px;
                height: 1080px;
                overflow: hidden;
                display: flex;
                justify-content: center;
                zoom: 0.5;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
            }

            .pic-blured{
                filter: blur(10px) brightness(15%);
                height: 100%;
                position: absolute;
                transform: scale(1.02);
            }

            .pic {
                position: absolute;
                top: 90px;
                padding: 0px 50px;
            }

            .mask{
                clip-path: inset(80px 50px 370px 50px);
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                z-index: 10;
                left: 0;
            }

            .text{
                line-height: 1.3em;
                text-align: left;
                color: #ffffff;
                height: 300px;
                z-index: 100;
                bottom: 0;
                font-weight: 900;
                position: absolute;
                word-break: break-word;
                /* text-shadow: 3px 4px #000000; */
                font-family: 'Lato', sans-serif !important;
            }

            .logo{
                position: absolute;
                z-index: 100;
                padding-top: 16px;
                width: 350px;
            }

            .nice-border{
                position: absolute;
                z-index: 110;
                height: 1035px;
                width: 100%;
                pointer-events: none;
            }
            
            .detail{
                position:absolute;
                z-index: 10000;
            }    

            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-button {
                display: none;
            }
            ::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.25);
            }
            ::-webkit-scrollbar-track {
                display: none;
            }

            .applogo {
                width: 200px;
            }
        </style>
    </head>
    <body>
        <div id="title-bar"></div>
        <div class="container-fluid pb-2 pt-3" style="overflow-y: scroll; height: calc(100% - 32px)">
            <div class="container">
                <img src="assets/images/applogo.png" class="applogo py-4"><span class="pl-2" id="version"></span>
                <div class="card bg-success text-white p-2 mb-4 text-center" style="display: none;" id="status"></div>
                <div class="row justify-content-center">
                    <div class="col-lg-12 col-xl-6 justify-content-center d-flex">
                        <div class="main mb-4" id="full-picture">
                            <div class="text align-self-center"></div>
                            <img src="assets/images/logo.png" class="logo">
                            <img src="assets/images/marco.png" class="nice-border">
                            <div class="mask">
                                <span class="d-flex justify-content-center">
                                    <img class="pic">
                                </span>
                            </div>
                            <img class="pic-blured">
                        </div>
                    </div>
                    <div class="col-lg-12 col-xl-6">
                        <div id="accordion">
                            <div class="card bg-dark text-white mb-4">
                                <div class="card-header bg-primary clickable collapsed" id="main" data-toggle="collapse" data-target="#main-config" aria-expanded="false" aria-controls="main-config">
                                    <h5 class="mb-0">
                                        Main Configuration
                                    </h5>
                                </div>
                                <div id="main-config" class="collapse" aria-labelledby="main" data-parent="#accordion">
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="fontsize">Brightness - <span></span></label>
                                            <input type="range" min="0" max="100" value="15" class="custom-range" id="brightness">
                                        </div>
                                        <div class="form-group">
                                            <label for="fontsize">Blur - <span></span></label>
                                            <input type="range" min="0" max="100" value="10" class="custom-range" id="blur">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card bg-dark text-white">
                                <div class="card-header bg-primary clickable" id="temp" data-toggle="collapse" data-target="#temp-config" aria-expanded="true" aria-controls="temp-config">
                                    <h5 class="mb-0">
                                        Temporal Configuration
                                    </h5>
                                </div>
                                <div id="temp-config" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                                    <div class="card-body">
                                    
                                        <div class="form-group">
                                            <label for="bg">Background URL</label>
                                            <input class="form-control" placeholder="URL Fondo" id="bg" value="https://e00-marca.uecdn.es/assets/multimedia/imagenes/2018/06/10/15286399998023.jpg">
                                        </div>
                                        <div class="form-group">
                                            <label for="text">Text</label>
                                            <input class="form-control" placeholder="Texto" id="text" value="Did you know that ##Kingdom Heart 3## is overrated?">
                                        </div>
                                        <div class="form-group">
                                            <label for="fontsize">Font size - <span></span></label>
                                            <input type="range" min="30" max="70" value="50" class="custom-range" id="fontsize">
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">                        
                                                <div class="form-group">
                                                    <label for="padding-h">Horizontal Padding - <span></span></label>
                                                    <input type="range" min="4" max="20" value="9" class="custom-range" id="padding-h">
                                                </div>
                                            </div>
                                            <div class="col-md-6">                        
                                                <div class="form-group">
                                                    <label for="padding-v">Vertical Padding - <span></span></label>
                                                    <input type="range" min="0" max="14" value="7" class="custom-range" id="padding-v">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="imagesize">Image size - <span></span></label>
                                            <input type="range" min="0" max="100" value="0" class="custom-range" id="imagesize">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mt-4">
                            <label for="text">File name</label>
                            <input class="form-control" placeholder="Nombre" id="filename" value="quicksave-news.png">
                        </div>
                        <button class="btn btn-primary" onclick="download(false)">Download</button>
                        <button class="btn btn-primary" disabled onclick="download(true)">Upload to Instagram</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const htmlToImage = require('html-to-image');
            const ElectronTitlebarWindows = require('electron-titlebar-windows');
            const pkg = require('./package.json')
            const titlebar = new ElectronTitlebarWindows({darkMode: true, draggable: true, fullscreen: true});
            titlebar.appendTo(document.getElementById("title-bar"));

            const prefs = {}
            const allPrefs = [
                {name: "brightness", field: "#brightness", unit: "%"},
                {name: "blur", field: "#blur", unit: "px"}
            ]

            const loadPrefs = () => {
                allPrefs.forEach(p => {
                    prefs[p.name] = localStorage.getItem(`pref-${p.name}`) || $(p.field).val()
                    $(p.field).val(prefs[p.name]); 
                })
            }

            const editPrefs = () => {
                allPrefs.forEach(p => {
                    localStorage.setItem(`pref-${p.name}`, $(p.field).val());
                    prefs[p.name] = $(p.field).val();
                })
            }

            $(document).ready(()=>{
                loadPrefs();
                applyChanges();
                loadImage();
                checkInstagramCreds();
                $("#main-config input").on("input", () => { editPrefs(); applyChanges(); })
                $("#temp-config input:not(#bg)").on("input", () => { applyChanges() })
                $("#bg").on("input", () => { loadImage(); })
                $(".pic").parent().draggable();
                $("#version").text(`v${pkg.version}`)

                $('#padding-h, #padding-v').on('mousedown', () => {
                    $(".text").css({
                        "background-image": "linear-gradient(to bottom, rgb(16, 0, 255) 0%, rgb(0, 0, 0) 100%), linear-gradient(to bottom, rgba(240, 40, 40, 1) 0%, rgba(240, 40, 40, 1) 100%)",
                        "background-clip": "content-box, padding-box"
                    });
                }).on('mouseup mouseleave', () => {
                    $(".text").css({
                        "background-image": "",
                        "background-clip": ""
                    }) 
                });
            });

            const checkInstagramCreds = () => {
                if(localStorage.getItem("instagram")){
                    $("#instagram-creds").removeClass("btn-danger")
                    $("#instagram-creds").addClass("btn-success")
                    $("#instagram-creds").text("Instagram configurado")
                } else {
                    $("#instagram-creds").addClass("btn-danger")
                    $("#instagram-creds").removeClass("btn-sucess")
                    $("#instagram-creds").text("Instagram no configurado")
                }
            }

            const loadImage = () => {
                $(".pic, .pic-blured").attr("src", $("#bg").val().trim());
                $(".pic").on("load", function() {
                    const height = this.naturalHeight;
                    const width = this.width;

                    $(".pic").css({
                        top: "90px",
                        left: 0,
                        right: 0,
                        bottom: 0
                    })

                    if(height > width){
                        $(".pic").width("1080px")
                    } else {
                        $(".pic").height("610px")
                    }
                })
            }

            const applyChanges = () => {
                const newText = $("#text").val().trim().replace(new RegExp(/##((.|\n)*?)##/, 'g'), `<span style='font-style: italic;'>$1</span>`);
                const fontSize = $("#fontsize").val()+"px";
                const padding = {
                    vertical: `${$("#padding-v").val()}%`,
                    horizontal: `${Number($("#padding-h").val())}%`
                }
                $("#fontsize").parent().find("label span").text(fontSize);
                $("#padding-v").parent().find("label span").text(padding.vertical);
                $("#padding-h").parent().find("label span").text(padding.horizontal);
                const imageSize = 1 + Number($("#imagesize").val()) / 100;
                $("#imagesize").parent().find("label span").text(100 + Number($("#imagesize").val())+"%");
                if(newText!= ""){
                    $(".text").html(newText)
                }

                $(".text").css({
                    "font-size": fontSize,
                    padding: `${padding.vertical} ${padding.horizontal}`
                });
                $(".pic").css("zoom", `${imageSize}`);

                $(".pic-blured").css("filter", `blur(${prefs.blur}${allPrefs.find(p => p.name == "blur").unit}) brightness(${prefs.brightness}${allPrefs.find(p => p.name == "brightness").unit})`)
                allPrefs.forEach(p => {
                    $(p.field).parent().find("label span").text(`${$(p.field).val()}${p.unit}`)
                })
            }

            const download = upload => {
                $("#full-picture").css({
                    "zoom":"1",
                    "position":"fixed"
                });
                $("#full-picture").css("position","fixed");
                htmlToImage.toPng(document.getElementById('full-picture'), {width: 1080, height: 1080}).then(dataUrl => {
                    $("#full-picture").css({
                        "zoom":"",
                        "position":"relative"
                    });
                    if(upload){
                        ipcRenderer.send("upload", dataUrl);
                    } else {
                        ipcRenderer.send("download", {image: dataUrl, filename: $("#filename").val()});
                    }
                });
            }

            const showStatus = (statusClass, text) => {
                $("#status").removeClass("bg-warning bg-danger bg-success bg-primary").toggleClass(statusClass).html(text).show();
            } 

            const update = () => {
                ipcRenderer.send("update")
                showStatus("bg-primary", "Downloading update...");
            }

            ipcRenderer.on("checking-for-update", (ev, text) => {
                showStatus("bg-primary", "Checking for updates...");
            })

            ipcRenderer.on("update-available", (ev, text) => {
                showStatus("bg-warning", 
                `<div class="row align-items-center justify-content-center">
                    <div class="col-auto">
                        An update is available!
                    </div>
                    <div class="col-auto my-1">
                        <button id='update-btn' onclick='update();' class='btn btn-outline-light'>
                            Update now
                        </button>
                    </div>
                </div>`);
            })

            ipcRenderer.on("update-not-available", (ev, text) => {
                showStatus("bg-success", "Social Plab is up to date!");
            })

            ipcRenderer.on("error", (ev, text) => {
                showStatus("bg-danger", "An error ocurred while checking updates :(");
            })

            ipcRenderer.on("download-progress", (ev, text) => {
                showStatus("bg-primary", text)
            })

            ipcRenderer.on("update-downloaded", (ev, text) => {
                showStatus("bg-primary", "Download complete!")
            })

            ipcRenderer.on("download-done", (event, path) => {
                if(path != "error"){
                    Swal.fire({
                        title: "Success",
                        text: `The image was saved in your Desktop.\n(${path})`,
                        type: "success",
                        toast: true
                    });
                } else {
                    Swal.fire("Error",`An error ocurred while saving the image.`,"error");
                }
            })

            titlebar.on('close', function(e) {
                ipcRenderer.send("close");
            });

            titlebar.on('maximize', function(e) {
                ipcRenderer.send("toggleMaximize");
            });

            titlebar.on('fullscreen', function(e) {
                ipcRenderer.send("toggleMaximize");
            });

            titlebar.on('minimize', function(e) {
                ipcRenderer.send("minimize");
            });
        </script>
    </body>
</html>