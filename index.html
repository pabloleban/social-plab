<html>
    <head>
        <meta charset="UTF-8">
        <script>
            window.$ = window.jQuery = require('jquery');
            require('jquery-ui-dist/jquery-ui')
            var {ipcRenderer, remote} = require('electron');
            require("bootstrap");
            const Swal = require('sweetalert2')
        </script>
        <link href="./node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato:900" rel="stylesheet">
        <title>Social Plab</title>
        <style>
            svg {
                height: 30px !important;
            }

            .titlebar{
                background: rgba(0, 0, 0, 0.3);
            }

            body{
                background: var(--dark);
                color: white;
                overflow: hidden;
            }

            .main{
                position: relative;
                width: 1080px;
                height: 1080px;
                overflow: hidden;
                display: flex;
                justify-content: center;
                zoom: 0.5;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
            }

            .pic-blured{
                filter: blur(10px) brightness(15%);
                height: 100%;
                position: absolute;
                transform: scale(1.02);
            }

            .pic {
                position: absolute;
                top: 90px;
                padding: 0px 50px;
            }

            .mask{
                clip-path: inset(80px 50px 370px 50px);
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                z-index: 10;
                left: 0;
            }

            .text{
                line-height: 1.3em;
                text-align: left;
                color: #ffffff;
                height: 300px;
                z-index: 100;
                bottom: 0;
                font-weight: 900;
                position: absolute;
                word-break: break-word;
                /* text-shadow: 3px 4px #000000; */
                font-family: 'Lato', sans-serif !important;
            }

            .logo{
                position: absolute;
                z-index: 100;
                padding-top: 16px;
                width: 350px;
            }

            .nice-border{
                position: absolute;
                z-index: 110;
                height: 1035px;
                width: 100%;
                pointer-events: none;
            }
            
            .detail{
                position:absolute;
                z-index: 10000;
            }    

            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-button {
                display: none;
            }
            ::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.25);
            }
            ::-webkit-scrollbar-track {
                display: none;
            }

            .applogo {
                width: 200px;
            }
        </style>
    </head>
    <body>
        <div id="title-bar"></div>
        <div class="container-fluid pb-2 pt-3" style="overflow-y: scroll; height: calc(100% - 32px)">
            <div class="container">
                <img src="assets/images/applogo.png" class="applogo py-4"><span class="pl-2" id="version"></span>
                <div class="row justify-content-center">
                    <div class="col-lg-12 col-xl-6 justify-content-center d-flex">
                        <div class="main mb-4" id="full-picture">
                            <div class="text align-self-center"></div>
                            <img src="assets/images/logo.png" class="logo">
                            <img src="assets/images/marco.png" class="nice-border">
                            <div class="mask">
                                <span class="d-flex justify-content-center">
                                    <img class="pic">
                                </span>
                            </div>
                            <img class="pic-blured">
                        </div>
                    </div>
                    <div class="col-lg-12 col-xl-6">
                        <!-- <div class="form-group">
                            <button class="btn btn-primary" onclick="settings()">Configuración</button>
                        </div> -->
                        <div class="form-group">
                            <label for="bg">URL Fondo</label>
                            <input class="form-control" placeholder="URL Fondo" id="bg" value="https://e00-marca.uecdn.es/assets/multimedia/imagenes/2018/06/10/15286399998023.jpg">
                        </div>
                        <div class="form-group">
                            <label for="text">Texto</label>
                            <input class="form-control" placeholder="Texto" id="text" value="Did you know that ##Kingdom Heart 3## is overrated?">
                        </div>
                        <div class="form-group">
                            <label for="fontsize">Tamaño fuente - <span></span></label>
                            <input type="range" min="30" max="70" value="50" class="custom-range" id="fontsize">
                        </div>
                        <div class="row">
                            <div class="col-md-6">                        
                                <div class="form-group">
                                    <label for="padding-h">Padding horizontal - <span></span></label>
                                    <input type="range" min="4" max="20" value="9" class="custom-range" id="padding-h">
                                </div>
                            </div>
                            <div class="col-md-6">                        
                                <div class="form-group">
                                    <label for="padding-v">Padding vertical - <span></span></label>
                                    <input type="range" min="0" max="14" value="7" class="custom-range" id="padding-v">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="imagesize">Tamaño de imagen - <span></span></label>
                            <input type="range" min="0" max="100" value="0" class="custom-range" id="imagesize">
                        </div>
                        <!-- <div class="form-group">
                            <label for="text">Descripción de Instagram</label>
                            <textarea class="form-control" placeholder="Descripción" id="description"></textarea>
                        </div> -->
                        <div class="form-group">
                            <label for="text">Nombre del archivo</label>
                            <input class="form-control" placeholder="Nombre" id="filename" value="instagram">
                        </div>
                        <button class="btn btn-primary" onclick="download(false)">Descargar</button>
                        <button class="btn btn-primary" disabled onclick="download(true)">Subir a Instagram</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const htmlToImage = require('html-to-image');
            const ElectronTitlebarWindows = require('electron-titlebar-windows');
            const pkg = require('./package.json')
            const titlebar = new ElectronTitlebarWindows({darkMode: true, draggable: true, fullscreen: true});
            titlebar.appendTo(document.getElementById("title-bar"));

            $(document).ready(()=>{
                applyChanges();
                loadImage();
                checkInstagramCreds();
                $("input:not(#bg)").on("input", () => { applyChanges() })
                $("#bg").on("input", () => { loadImage(); })
                $(".pic").parent().draggable();
                $("#version").text(`v${pkg.version}`)

                $('#padding-h, #padding-v').on('mousedown', () => {
                    $(".text").css({
                        "background-image": "linear-gradient(to bottom, rgb(16, 0, 255) 0%, rgb(0, 0, 0) 100%), linear-gradient(to bottom, rgba(240, 40, 40, 1) 0%, rgba(240, 40, 40, 1) 100%)",
                        "background-clip": "content-box, padding-box"
                    });
                }).on('mouseup mouseleave', () => {
                    $(".text").css({
                        "background-image": "",
                        "background-clip": ""
                    }) 
                });
            });

            const settings = () => {
                Swal.fire({
                    title: "Configuración permanente",
                    html: `Configurar.`,
                    type: "success"
                });
            }

            const checkInstagramCreds = () => {
                if(localStorage.getItem("instagram")){
                    $("#instagram-creds").removeClass("btn-danger")
                    $("#instagram-creds").addClass("btn-success")
                    $("#instagram-creds").text("Instagram configurado")
                } else {
                    $("#instagram-creds").addClass("btn-danger")
                    $("#instagram-creds").removeClass("btn-sucess")
                    $("#instagram-creds").text("Instagram no configurado")
                }
            }

            const loadImage = () => {
                $(".pic, .pic-blured").attr("src", $("#bg").val().trim());
                $(".pic").on("load", function() {
                    const height = this.naturalHeight;
                    const width = this.width;

                    $(".pic").css({
                        top: "90px",
                        left: 0,
                        right: 0,
                        bottom: 0
                    })

                    if(height > width){
                        $(".pic").width("1080px")
                    } else {
                        $(".pic").height("610px")
                    }
                })
            }

            const applyChanges = () => {
                const newText = $("#text").val().trim().replace(new RegExp(/##((.|\n)*?)##/, 'g'), `<span style='font-style: italic;'>$1</span>`);
                const fontSize = $("#fontsize").val()+"px";
                const padding = {
                    vertical: `${$("#padding-v").val()}%`,
                    horizontal: `${Number($("#padding-h").val())}%`
                }
                $("#fontsize").parent().find("label span").text(fontSize);
                $("#padding-v").parent().find("label span").text(padding.vertical);
                $("#padding-h").parent().find("label span").text(padding.horizontal);
                const imageSize = 1 + Number($("#imagesize").val()) / 100;
                $("#imagesize").parent().find("label span").text(100 + Number($("#imagesize").val())+"%");
                if(newText!= ""){
                    $(".text").html(newText)
                }

                $(".text").css({
                    "font-size": fontSize,
                    padding: `${padding.vertical} ${padding.horizontal}`
                });
                $(".pic").css("zoom", `${imageSize}`);
            }

            const download = upload => {
                $("#full-picture").css({
                    "zoom":"1",
                    "position":"fixed"
                });
                $("#full-picture").css("position","fixed");
                htmlToImage.toPng(document.getElementById('full-picture'), {width: 1080, height: 1080}).then(dataUrl => {
                    $("#full-picture").css({
                        "zoom":"",
                        "position":"relative"
                    });
                    if(upload){
                        ipcRenderer.send("upload", dataUrl);
                    } else {
                        ipcRenderer.send("download", {image: dataUrl, filename: $("#filename").val()});
                    }
                });
            }

            ipcRenderer.on("download-done", (event, path) => {
                if(path != "error"){
                    Swal.fire({
                        title: "Éxito",
                        text: `Se guardó la imagen en el escritorio.\n(${path})`,
                        type: "success",
                        toast: true
                    });
                } else {
                    Swal.fire("Error",`Ocurrió un error al intentar guardar la imagen.`,"error");
                }
            })

            titlebar.on('close', function(e) {
                ipcRenderer.send("close");
            });

            titlebar.on('maximize', function(e) {
                ipcRenderer.send("toggleMaximize");
            });

            titlebar.on('fullscreen', function(e) {
                ipcRenderer.send("toggleMaximize");
            });

            titlebar.on('minimize', function(e) {
                ipcRenderer.send("minimize");
            });
        </script>
    </body>
</html>